# MPRIORITY 2.0 Backend

Express API сервер для расчетов метода анализа иерархий (AHP).

## API Endpoints

### GET `/health`
Проверка работоспособности сервера

### POST `/api/check-consistency`
Проверка согласованности матрицы парных сравнений

**Request Body:**
```json
{
  "matrix": [[1, 2, 3], [0.5, 1, 2], [0.33, 0.5, 1]]
}
```

**Response:**
```json
{
  "priorities": [0.539, 0.297, 0.164],
  "lambdaMax": 3.009,
  "ci": 0.005,
  "cr": 0.008,
  "isConsistent": true,
  "n": 3
}
```

### POST `/api/calculate-global-priorities`
Расчет глобальных приоритетов альтернатив

**Request Body:**
```json
{
  "hierarchy": {
    "goal": "Выбор ноутбука",
    "criteria": ["Цена", "Производительность", "Вес"],
    "alternatives": ["Модель A", "Модель B", "Модель C"]
  },
  "criteriaMatrix": [[1, 2, 3], [0.5, 1, 2], [0.33, 0.5, 1]],
  "alternativeMatrices": [
    [[1, 2, 3], [0.5, 1, 2], [0.33, 0.5, 1]],
    [[1, 0.5, 0.33], [2, 1, 0.5], [3, 2, 1]],
    [[1, 3, 2], [0.33, 1, 0.5], [0.5, 2, 1]]
  ]
}
```

### POST `/api/analyze-results`
Детальный разбор результатов анализа с помощью Google Gemini AI

**Request Body:**
```json
{
  "hierarchy": {
    "goal": "Выбор ноутбука",
    "criteria": ["Цена", "Производительность", "Вес"],
    "alternatives": ["Модель A", "Модель B", "Модель C"]
  },
  "results": {
    "globalPriorities": [...],
    "criteriaPriorities": [...],
    "criteriaConsistency": {...},
    "alternativeConsistencies": [...]
  }
}
```

**Response:**
```json
{
  "analysis": "Детальный анализ результатов на русском языке...",
  "model": "gemini-2.5-flash"
}
```

**Требования:** Необходимо установить переменную окружения `GEMINI_API_KEY` с API ключом от Google Gemini.

### Механика автоматического fallback моделей Gemini

Система автоматически пробует модели Gemini в следующем порядке приоритета:

1. **gemini-2.5-flash** - самая новая и быстрая модель (приоритет 1)
2. **gemini-1.5-flash** - быстрая и широко доступная модель (приоритет 2)
3. **gemini-1.5-pro** - более мощная модель для сложных задач (приоритет 3)
4. **gemini-pro** - legacy версия для совместимости (приоритет 4)

**Как это работает:**
- При первом запросе система пробует использовать модель с наивысшим приоритетом
- Если модель недоступна или возвращает ошибку, автоматически переключается на следующую модель в списке
- Выбранная модель сохраняется для последующих запросов
- Если текущая модель перестает работать, система автоматически переключается на следующую доступную модель
- В ответе API указывается имя модели, которая была использована для генерации анализа

Это обеспечивает максимальную надежность и использование самых современных доступных моделей.

## Установка и запуск

```bash
npm install
npm start
```

Сервер запустится на порту, указанном в переменной окружения `PORT` (по умолчанию 3001).

## Переменные окружения

- `PORT` - Порт для запуска сервера (по умолчанию 3001)
- `GEMINI_API_KEY` - API ключ Google Gemini для функции детального анализа результатов. Получить можно на https://makersuite.google.com/app/apikey
