# MPRIORITY 2.0 Backend

Express API сервер для расчетов метода анализа иерархий (AHP).

## API Endpoints

### GET `/health`
Проверка работоспособности сервера

### POST `/api/check-consistency`
Проверка согласованности матрицы парных сравнений

**Request Body:**
```json
{
  "matrix": [[1, 2, 3], [0.5, 1, 2], [0.33, 0.5, 1]]
}
```

**Response:**
```json
{
  "priorities": [0.539, 0.297, 0.164],
  "lambdaMax": 3.009,
  "ci": 0.005,
  "cr": 0.008,
  "isConsistent": true,
  "n": 3
}
```

### POST `/api/calculate-global-priorities`
Расчет глобальных приоритетов альтернатив

**Request Body:**
```json
{
  "hierarchy": {
    "goal": "Выбор ноутбука",
    "criteria": ["Цена", "Производительность", "Вес"],
    "alternatives": ["Модель A", "Модель B", "Модель C"]
  },
  "criteriaMatrix": [[1, 2, 3], [0.5, 1, 2], [0.33, 0.5, 1]],
  "alternativeMatrices": [
    [[1, 2, 3], [0.5, 1, 2], [0.33, 0.5, 1]],
    [[1, 0.5, 0.33], [2, 1, 0.5], [3, 2, 1]],
    [[1, 3, 2], [0.33, 1, 0.5], [0.5, 2, 1]]
  ]
}
```

### POST `/api/analyze-results`
Детальный разбор результатов анализа с помощью Google Gemini AI

**Request Body:**
```json
{
  "hierarchy": {
    "goal": "Выбор ноутбука",
    "criteria": ["Цена", "Производительность", "Вес"],
    "alternatives": ["Модель A", "Модель B", "Модель C"]
  },
  "results": {
    "globalPriorities": [...],
    "criteriaPriorities": [...],
    "criteriaConsistency": {...},
    "alternativeConsistencies": [...]
  }
}
```

**Response:**
```json
{
  "analysis": "Детальный анализ результатов на русском языке...",
  "model": "gemini-2.5-flash"
}
```

**Требования:** Необходимо установить переменную окружения `GEMINI_API_KEY` с API ключом от Google Gemini.

### Механика автоматического fallback моделей Gemini

Система автоматически пробует модели Gemini в следующем порядке приоритета:

1. **gemini-2.5-flash** - самая новая и быстрая модель (приоритет 1)
2. **gemini-1.5-flash** - быстрая и широко доступная модель (приоритет 2)
3. **gemini-1.5-pro** - более мощная модель для сложных задач (приоритет 3)
4. **gemini-pro** - legacy версия для совместимости (приоритет 4)

**Как это работает:**
- При первом запросе система пробует использовать модель с наивысшим приоритетом
- Если модель недоступна или возвращает ошибку, автоматически переключается на следующую модель в списке
- Выбранная модель сохраняется для последующих запросов
- Если текущая модель перестает работать, система автоматически переключается на следующую доступную модель
- В ответе API указывается имя модели, которая была использована для генерации анализа

Это обеспечивает максимальную надежность и использование самых современных доступных моделей.

## Установка и запуск

```bash
npm install
npm start
```

Сервер запустится на порту, указанном в переменной окружения `PORT` (по умолчанию 3001).

### POST `/api/analyses`
Сохранение анализа в базу данных

**Request Body:**
```json
{
  "goal": "Выбор ноутбука",
  "criteria": ["Цена", "Производительность"],
  "alternatives": ["Модель A", "Модель B"],
  "criteriaMatrix": [[1, 2], [0.5, 1]],
  "alternativeMatrices": [
    [[1, 2], [0.5, 1]],
    [[1, 0.5], [2, 1]]
  ],
  "results": {...}
}
```

**Response:**
```json
{
  "success": true,
  "id": "analysis_1234567890_abc123",
  "timestamp": 1234567890
}
```

### GET `/api/analyses`
Получение всех анализов с пагинацией

**Query Parameters:**
- `limit` - Количество анализов (по умолчанию 50)
- `offset` - Смещение (по умолчанию 0)

**Response:**
```json
{
  "analyses": [...],
  "total": 100,
  "limit": 50,
  "offset": 0
}
```

### GET `/api/analyses/:id`
Получение анализа по ID

**Response:**
```json
{
  "id": "analysis_1234567890_abc123",
  "timestamp": 1234567890,
  "goal": "Выбор ноутбука",
  "criteria": ["Цена", "Производительность"],
  "alternatives": ["Модель A", "Модель B"],
  "criteriaMatrix": [[1, 2], [0.5, 1]],
  "alternativeMatrices": [...],
  "results": {...},
  "createdAt": "2025-12-28T12:00:00.000Z"
}
```

### DELETE `/api/analyses/:id`
Удаление анализа по ID

**Response:**
```json
{
  "success": true,
  "message": "Анализ удален"
}
```

## Переменные окружения

- `PORT` - Порт для запуска сервера (по умолчанию 3001)
- `GEMINI_API_KEY` - API ключ Google Gemini для функции детального анализа результатов. Получить можно на https://makersuite.google.com/app/apikey
- `DATABASE_URL` - URL подключения к PostgreSQL (для Railway автоматически предоставляется)
  - Формат: `postgresql://user:password@host:port/database`
  - Для локальной разработки можно использовать отдельные переменные:
    - `DB_USER` - Имя пользователя БД (по умолчанию `postgres`)
    - `DB_PASSWORD` - Пароль БД (по умолчанию `postgres`)
    - `DB_HOST` - Хост БД (по умолчанию `localhost`)
    - `DB_PORT` - Порт БД (по умолчанию `5432`)
    - `DB_NAME` - Имя БД (по умолчанию `mpriority`)

## База данных

Приложение использует PostgreSQL для хранения анализов. При первом запуске автоматически создается таблица `analyses` со следующей структурой:

- `id` (TEXT PRIMARY KEY) - Уникальный идентификатор анализа
- `timestamp` (BIGINT) - Временная метка создания
- `goal` (TEXT) - Цель анализа
- `criteria` (JSONB) - Массив критериев
- `alternatives` (JSONB) - Массив альтернатив
- `criteria_matrix` (JSONB) - Матрица сравнения критериев
- `alternative_matrices` (JSONB) - Матрицы сравнения альтернатив по каждому критерию
- `results` (JSONB) - Результаты расчета (опционально)
- `created_at` (TIMESTAMP) - Время создания записи

### Настройка PostgreSQL на Railway

1. Создайте новый PostgreSQL сервис в Railway
2. Railway автоматически предоставит переменную окружения `DATABASE_URL`
3. Приложение автоматически подключится к БД при запуске
4. Таблица создается автоматически при первом запуске
